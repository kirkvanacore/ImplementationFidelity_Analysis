---
title: "Class Level Fidelity"
author: "Kirk Vanacore"
date: "9/15/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r, include=FALSE}
####Installing & Loading Packages###
#create list of packages
packages = c(
  "tidyverse",
  "plyr",
  "ggplot2",
  "lme4",
  "dplyr",
  "psych",
  "ggExtra",
  "xts",
  "lubridate",
  "readxl",
  "data.table",
  "RSQLite",
  "DBI",
  "gridExtra",
  "patchwork",
  'mclust',
  'plotly',
  'stringr',
  'corrplot'
) 
#load install
package.check <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
) 
rm(package.check, packages)

ifnull <- function(x , alt ){
  if(is.na(x)){
    x = alt
  }
  x
}
ifnull <- function(x , alt ) {
  ifelse(is.na(x), alt, x)
  
}


```

# Fidelity Metric

> Science  cannot  study  what  it  cannot  measure  accurately  and  cannot  measure  what  it  does  not  define (Durlak & DuPre, 2008).

* Fidelity is using the program as it was intended (Durlak & DuPre, 2008)
* In this study practitioners were expected to to assigning the online assignments and create time for students to utilize the program
* Our working definition of minimum fidelity is whether this expectation was met
* Because the action of assigning metrics was not measured directly, we utilize whether at least 25% students within a class started each assignment as our threshold for minimum fidelity
 


```{r, include=F, echo=F}
ies_research_con <- dbConnect(RSQLite::SQLite(),
                              "/Users/kirkvanacore/Documents/WPI Analyses/MAPLE_IES_DB_Creation/ies_research schema/maple_ies_research.db")

test <- dbGetQuery(ies_research_con, 
"select asp.*,
    meta.curricula,
    meta.problem_type

from assist_student_problem as asp
left join assist_problems_meta as meta on asp.problem_id = meta.problem_id

where meta.math_problem = 1;"
                   )

dat <- dbGetQuery(ies_research_con, 
" select sr.StuID,
    sr.SchIDPre,
    sr.SchIDEnd,
    sr.TeaIDPre,
    sr.TeaIDEnd,
    sr.TeaIDEnd_within_school,
    sr.ClaIDPre,
    sr.ClaIDEnd,
    sr.rdm_condition,
    sr.condition_assignment,
    sr.inperson,
    sr.virtual,
    sr.stay_INPERSON,
    sr.stay_VIRTUAL,
    sr.INP_VIR,
    sr.VIR_INP,
    sd.FEMALE,
    sd.MALE,
    sd.race_ethnicity,
    sd.IEP,
    sd.EIP,
    sd.ESOL,
    sd.GIFTED,
    sf.*,
    fs.num_attempted as fh2t_num_attempted,
    fs.per_total_problem_complete as fh2t_per_total_problem_complete,
    fs.total_time as fh2t_total_time,
    sa.num_graded_problems_attempted as assist_num_graded_problems_attempted,  
    sa.per_graded_problems_attempted as assist_per_graded_problems_attempted,  
    sa.total_time as assist_total_time,
    ds.Total_Problem_Device as dragon_total_problems_attempted  ,
    sr.DROPSCH1,
    sr.DROPSCH2,
    sr.RESOURCE
    


    
    

from student_roster sr
    left join student_demo sd on sd.StuID = sr.StuID
    left join student_fidelity sf on sf.StuID = sr.StuID
    left join fh2t_student fs on fs.StuID = sr.StuID
    left join assist_student sa on sa.StuID = sr.StuID
    left join dragon_student ds on ds.StuID = sr.StuID


where sr.COND4092 is not null

;"
    
 )



# drop dup columns (from my lazy query)
unique_names <- unique(colnames(dat))

# Keep Only Unique Column Names
dat<-dat[unique_names]

rm(unique_names)


```



### Cleaning
```{r}

### condition
table(dat$condition_assignment)
dat$condition_assignment = factor(dat$condition_assignment,
  levels = c("FH2T", "DragonBox", "Instant", "Delay")
)


### assignments stated
dat$total_assignmnet_started <- 
           ifnull(dat$started_assignment_2,0) +
           ifnull(dat$started_assignment_3,0) +
           ifnull(dat$started_assignment_4,0) +
           ifnull(dat$started_assignment_5,0) +
           ifnull(dat$started_assignment_7,0) +
           ifnull(dat$started_assignment_8,0) +
           ifnull(dat$started_assignment_9,0) +
           ifnull(dat$started_assignment_10,0) +
           ifnull(dat$started_assignment_11,0) 

table(is.na(dat$total_assignmnet_started))

table(dat$total_assignmnet_started, dat$fidelity_complete_sum)
table(dat$fidelity_complete_sum)
table(dat$total_assignmnet_started)

table(dat$total_assignmnet_started == 9)
table(dat$total_assignmnet_started == 9)/length(dat$total_assignmnet_started)
dat$percent_assignmnet_started <- dat$total_assignmnet_started/9


psych::describe(dat$total_assignmnet_started)
psych::describe(dat$percent_assignmnet_started)


### assignments completed
dat$total_assignmnet_complete <- 
           ifnull(dat$complete_assignment_2,0) +
           ifnull(dat$complete_assignment_3,0) +
           ifnull(dat$complete_assignment_4,0) +
           ifnull(dat$complete_assignment_5,0) +
           ifnull(dat$complete_assignment_7,0) +
           ifnull(dat$complete_assignment_8,0) +
           ifnull(dat$complete_assignment_9,0) +
           ifnull(dat$complete_assignment_10,0) +
           ifnull(dat$complete_assignment_11,0) 

table(is.na(dat$total_assignmnet_complete))

table(is.na(dat$total_assignmnet_complete))

table(dat$total_assignmnet_complete == 9)
table(dat$total_assignmnet_complete == 9)/length(dat$total_assignmnet_complete)
dat$percent_assignmnet_complete <- dat$total_assignmnet_complete/9


psych::describe(dat$total_assignmnet_complete)
psych::describe(dat$percent_assignmnet_complete)


### create In_Vr_Moved 
dat$inperson_virtual = ifelse(
  dat$stay_VIRTUAL == 1, "VIRTUAL", 
  ifelse(
    dat$stay_INPERSON == 1, "INPERSON",
  "MIXED"
  )
)
table(dat$inperson_virtual)



### time

describe(dat$assist_total_time/(60000))
describe(dat$fh2t_total_time/(60000))

table(is.na(dat$assist_total_time), is.na(dat$fh2t_total_time), dat$condition_assignment)


dat$in_program_time_mins <-
  ifelse(
    dat$total_assignmnet_complete == 0,
    0,
    ifelse(
      is.na(dat$assist_total_time) == T,
      dat$fh2t_total_time,
      dat$assist_total_time
      
    )
  ) / 60000

table(is.na(dat$in_program_time_mins))
table(is.na(dat$in_program_time_mins), dat$total_assignmnet_started)
table(is.na(dat$in_program_time_mins), dat$total_assignmnet_complete)

describe(dat$in_program_time_mins)


# problems
describe(dat$assist_num_graded_problems_attempted)
describe(dat$fh2t_num_attempted)

describe(dat$assist_per_graded_problems_attempted)
  describe(dat$fh2t_per_total_problem_complete)
table(dat$assist_per_graded_problems_attempted  > 1)
hist(dat$assist_per_graded_problems_attempted)
hist(dat$fh2t_per_total_problem_complete)



dat$problems_attempted <-
  ifelse(dat$total_assignmnet_complete == 0, 0, 
  ifelse(
    is.na(dat$fh2t_num_attempted) == F,
    dat$fh2t_num_attempted,
    ifelse(
      is.na(dat$dragon_total_problems_attempted) == F,
      dat$dragon_total_problems_attempted,
      ifelse(is.na(dat$assist_num_graded_problems_attempted) == F,
             dat$assist_num_graded_problems_attempted,
             ifelse(dat$total_assignmnet_started == 0, 0, NA)))))

table(is.na(dat$problems_attempted), dat$total_assignmnet_complete, dat$rdm_condition)

dat_CHECK <- dat %>%
  dplyr::select(StuID, rdm_condition, total_assignmnet_started, total_assignmnet_complete, problems_attempted) %>% filter(is.na(problems_attempted))

table(dat_CHECK$rdm_condition, dat_CHECK$total_assignmnet_complete)

table(dat_CHECK$rdm_condition)
rm(dat_CHECK)

### missing log-file data
table(is.na(dat$in_program_time_mins), is.na(dat$problems_attempted))



#percent of available problems problems attempt


dat$per_problems_attempted <-
  ifelse((dat$problems_attempted) == 0,
         0,
         ifelse(
           is.na(dat$assist_per_graded_problems_attempted) == T,
           dat$fh2t_per_total_problem_complete,
           dat$assist_per_graded_problems_attempted *
             100
           
         ))
table(is.na(dat$per_problems_attempted ))
table(is.na(dat$per_problems_attempted ), (dat$problems_attempted) > 0)

describe(dat$problems_attempted)
describeBy(dat$problems_attempted, dat$condition_assignment)

describe(dat$per_problems_attempted)
describeBy(dat$per_problems_attempted, dat$condition_assignment)


dat$avg_problems_completed_per_assign<-ifelse(dat$total_assignmnet_started == 0, 0, dat$problems_attempted/dat$total_assignmnet_started)
describeBy(dat$avg_problems_completed_per_assign, dat$condition_assignment)

```

# Sample
```{r}
# orginal rangmized sample
# number of students 
length(unique(dat$StuID))
# number of reachers 
length(unique(dat$TeaIDPre))
# number of schools
length(unique(dat$SchIDPre))
# students in resource room
table(dat$RESOURCE)

table(is.na(dat$TeaIDEnd))
table(is.na(dat$SchIDEnd))
table(is.na(dat$TeaIDEnd), is.na(dat$SchIDEnd))

table(is.na(dat$TeaIDPre == dat$TeaIDEnd))
table(is.na(dat$SchIDPre == dat$SchIDEnd))

### Clean 
dat <- dat %>%
  filter(
    DROPSCH1 == 0,
    RESOURCE == 0,
    is.na(dat$SchIDEnd) == F,
    is.na(dat$TeaIDEnd) == F,
    condition_assignment != "DragonBox",
    is.na(dat$in_program_time_mins) == F,
    is.na(dat$problems_attempted) == F
  )

# orginal rangmized sample
# number of students 
length(unique(dat$StuID))
# number of reachers 
length(unique(dat$TeaIDEnd))
table(is.na(dat$TeaIDPre))

# number of schools
length(unique(dat$SchIDPre))
table(is.na(dat$TeaIDEnd))

# students in resource room
length(unique(dat$RESOURCE))

```
# demographics
```{r}
# race ethnicity 
table(is.na(dat$race_ethnicity))/length(dat$race_ethnicity)
round(table(dat$race_ethnicity)/length(dat$race_ethnicity)*100, 2)

# Gender
table((dat$MALE))/length(dat$MALE)
table((dat$FEMALE))/length(dat$MALE)
table(is.na(dat$FEMALE))/length(dat$MALE)


# Gender
table((dat$IEP))/length(dat$IEP)

# Gender
table((dat$GIFTED))/length(dat$GIFTED)

```


# Results
## RQ1 Fedility Metic Exploration: Student  Level Metrics
```{r}
# RQ 1 


### assignments started
desc_assignmnet_started<-as.data.frame(psych::describe((dat$total_assignmnet_started/9)*100))

describeBy((dat$total_assignmnet_started/9)*100, group = dat$inperson_virtual)
summary(
aov(
  dat$total_assignmnet_started ~dat$inperson_virtual
))
TukeyHSD(aov(
  dat$total_assignmnet_started ~dat$inperson_virtual
))



desc_assignmnet_completed<-as.data.frame(psych::describe((dat$total_assignmnet_complete/9)*100))

# assignments completed
describeBy((dat$total_assignmnet_complete/9)*100, group = dat$inperson_virtual)



kableExtra::kable(
  rbind(desc_assignmnet_started, desc_assignmnet_completed),
  digits = 2
)




# overall 
mean(dat$percent_assignmnet_complete)
sd(dat$percent_assignmnet_complete)

p<- as.numeric(table(dat$percent_assignmnet_complete == 1)/length(dat$percent_assignmnet_complete))
p
sqrt(p[2]*(1-p[2]))

## in-person 
mean(dat[dat$stay_INPERSON == 1,]$percent_assignmnet_complete)
sd(dat[dat$stay_INPERSON == 1,]$percent_assignmnet_complete)
p<-as.numeric(table(dat[dat$stay_INPERSON == 1,]$percent_assignmnet_complete == 1) / length(dat[dat$stay_INPERSON == 1,]$percent_assignmnet_complete))
p[2]
sqrt(p[2]*(1-p[2]))

## remote
mean(dat[dat$stay_VIRTUAL == 1,]$percent_assignmnet_complete)
sd(dat[dat$stay_VIRTUAL == 1,]$percent_assignmnet_complete)
p<-as.numeric(table(dat[dat$stay_VIRTUAL == 1,]$percent_assignmnet_complete == 1)/length(dat[dat$stay_VIRTUAL == 1,]$percent_assignmnet_complete))
p[2]
sqrt(p[2]*(1-p[2]))

## mixed
mean(dat[dat$inperson_virtual == "MIXED",]$percent_assignmnet_complete)
sd(dat[dat$inperson_virtual == "MIXED",]$percent_assignmnet_complete)
p<-as.numeric(table(dat[dat$inperson_virtual == "MIXED",]$percent_assignmnet_complete == 1)/length(dat[dat$inperson_virtual == "MIXED",]$percent_assignmnet_complete))


```

```{r}
cbind(
t(dat %>%
  summarise(
    condition_assignment = "ALL",
    started_mean = paste0(round(mean((percent_assignmnet_started)*100), 2), " (",round(sd((percent_assignmnet_started)*100), 2),")"),
    complete_mean = paste0(round(mean((percent_assignmnet_complete)*100), 2), " (",round(sd((percent_assignmnet_complete)*100), 2),")"),
    time_mean = paste0(round(mean(in_program_time_mins, na.rm = T), 2), " (",round(sd(in_program_time_mins, na.rm = T), 2),")"),
    problems_mean = paste0(round(mean(problems_attempted, na.rm = T), 2), " (",round(sd(problems_attempted, na.rm = T), 2),")"),
      avg_problems_per_assign = paste0(round(mean(avg_problems_completed_per_assign, na.rm = T), 2), " (",round(sd(avg_problems_completed_per_assign, na.rm = T), 2),")"),
    pre_problems_mean = paste0(round(mean(per_problems_attempted, na.rm = T), 2), " (",round(sd(per_problems_attempted, na.rm = T),2),")")
  )  )
,
t(
dat %>%
  dplyr::ungroup() %>%
  dplyr::group_by(condition_assignment) %>%
  dplyr::summarise(
    started_mean = paste0(round(mean((percent_assignmnet_started)*100), 2), " (",round(sd((percent_assignmnet_started)*100), 2),")"),
    complete_mean = paste0(round(mean((percent_assignmnet_complete)*100), 2), " (",round(sd((percent_assignmnet_complete)*100), 2),")"),
    time_mean = paste0(round(mean(in_program_time_mins, na.rm = T), 2), " (",round(sd(in_program_time_mins, na.rm = T), 2),")"),
    problems_mean = paste0(round(mean(problems_attempted, na.rm = T), 2), " (",round(sd(problems_attempted, na.rm = T), 2),")"),
    avg_problems_per_assign = paste0(round(mean(avg_problems_completed_per_assign, na.rm = T), 2), " (",round(sd(avg_problems_completed_per_assign, na.rm = T), 2),")"),
    pre_problems_mean = paste0(round(mean(per_problems_attempted, na.rm = T), 2), " (",round(sd(per_problems_attempted, na.rm = T),2),")")
  ))

)
```


```{r}
#### Equivalence #####

# assignments started
summary(
aov(
  dat$total_assignmnet_started ~dat$condition_assignment
))
TukeyHSD(aov(
  dat$total_assignmnet_started ~dat$condition_assignment
))


# assignments completed
summary(
aov(
  dat$total_assignmnet_complete~dat$condition_assignment
))
TukeyHSD(aov(
  dat$total_assignmnet_complete ~dat$condition_assignment
))


# time
summary(
aov(
  dat$in_program_time_mins~dat$condition_assignment
))
TukeyHSD(aov(
  dat$in_program_time_mins ~dat$condition_assignment
))

# problems
summary(
aov(
  dat$problems_attempted~dat$in_program_time_mins
))
TukeyHSD(aov(
  dat$problems_attempted ~dat$condition_assignment
))


# avg_problems_completed_per_assign
summary(
aov(
  dat$avg_problems_completed_per_assign~dat$in_program_time_mins
))
TukeyHSD(aov(
  dat$avg_problems_completed_per_assign ~ 
    dat$condition_assignment
))

# per_problems_attempted
summary(
aov(
  dat$avg_problems_completed_per_assign~dat$per_problems_attempted
))
TukeyHSD(aov(
  dat$per_problems_attempted ~ 
    dat$condition_assignment
))


```

```{r}
cor.test(dat$total_assignmnet_complete, dat$total_assignmnet_started)
# corrplot::corrplot(
#     cor(dat %>%
#           select(
#             total_assignmnet_started,
#             total_assignmnet_complete,
#             in_program_time_mins,
#             problems_attempted,
#             avg_problems_completed_per_assign,
#             per_problems_attempted
#             
#           ),  use= "pairwise.complete.obs"),
#     
# 
# )
corrplot(

cor(as.data.frame.matrix( dat %>%
          select(
            total_assignmnet_started,
            total_assignmnet_complete,
            in_program_time_mins,
            problems_attempted,
            avg_problems_completed_per_assign,
            per_problems_attempted)
            
          )),

cor.mtest(as.data.frame.matrix( dat %>%
          select(
            total_assignmnet_started,
            total_assignmnet_complete,
            in_program_time_mins,
            problems_attempted,
            avg_problems_completed_per_assign,
            per_problems_attempted)
            
          )))



```

```{r}

## strandarize problems attempted

dat<-dat %>%
  ungroup() %>%
  dplyr::mutate(
    problems_attempted_Z = scale(problems_attempted)
  ) %>%
  dplyr::group_by(condition_assignment) %>%
  dplyr::mutate(
    problems_attempted_mean = mean(problems_attempted, na.rm = T),
    problems_attempted_sd = sd(problems_attempted, na.rm = T),
    avg_problems_completed_per_assign_mean = mean(avg_problems_completed_per_assign, na.rm = T),
    avg_problems_completed_per_assign_sd = sd(avg_problems_completed_per_assign, na.rm = T),
    
  ) %>%
  ungroup() %>%
  dplyr::mutate(
    problems_attempted_Z_condition = (problems_attempted - problems_attempted_mean)/problems_attempted_sd,
    avg_problems_completed_per_assign_Z_condition = (avg_problems_completed_per_assign - avg_problems_completed_per_assign_mean)/avg_problems_completed_per_assign_sd
  ) 
summary(dat$problems_attempted_Z_condition)
table(dat$problems_attempted_Z_condition == dat$problems_attempted_Z)

fig1a <- dat %>%
  dplyr::group_by(condition_assignment) %>%
  dplyr::mutate(problem_mean = mean(problems_attempted, na.rm = T)) %>%
  ggplot(aes(x = problems_attempted, fill = condition_assignment)) +
  geom_density(alpha = .7)  +
  theme_classic() +
  geom_vline(aes(xintercept = problem_mean) ) +
  labs(title = "Raw Number of Problems Attempted",
       fill = "Condition") +
  scale_x_continuous(name = "Problems Attempted (Raw)")
    

fig1b <- dat %>%
  ggplot(aes(x = problems_attempted_Z_condition, fill = condition_assignment,
             color = condition_assignment)) +
  geom_density(alpha = .7) +
  theme_classic() +
  labs(title = "Standardized Number of Problems Attempted",
    fill = "Condition") +
  scale_x_continuous(name = "Problems Attempted (Z-score)")
  

fig1a + fig1b + plot_layout(guides = "collect")




dat %>%
  ggplot(aes(x = (avg_problems_completed_per_assign), fill = condition_assignment,
             color = condition_assignment)) +
  geom_density(alpha = .7) +
  theme_classic() +
  labs(title = "Standardized Number of Problems Attempted",
    fill = "Condition") +
  scale_x_continuous(name = "Problems Attempted (Z-score)")
  

fig1a + fig1b + plot_layout(guides = "collect")


```

cor
```{r}
corr.test(dat$problems_attempted_Z_condition, dat$per_problems_attempted)

dat %>% 
  dplyr::group_by(condition_assignment) %>%
  filter(!is.na(in_program_time_mins)) %>%
  dplyr::summarise(
    mean = mean(percent_assignmnet_complete),
    cor = (cor(percent_assignmnet_complete, in_program_time_mins)))
  
cor<-corr.test(dat$percent_assignmnet_complete, dat$in_program_time_mins)$r
cor
corr.test(dat$percent_assignmnet_started, dat$percent_assignmnet_complete)

```
# metric cor 
```{r}


library(Hmisc)
rcorr(as.matrix(dat %>%
  select(
    "Assignments Started" =percent_assignmnet_started,
    "Total Problems*" =problems_attempted_Z_condition,
    "Problems per Assignment*" =avg_problems_completed_per_assign_Z_condition
  )),type="pearson")

```
## RQ2 ICCS
### Assignments started
```{r}
dat$Teacher <- ifelse(is.na(dat$TeaIDEnd) == T, dat$TeaIDPre, dat$TeaIDEnd)

assign_var<-as.data.frame( VarCorr(lmer(percent_assignmnet_started ~ (1 | SchIDEnd/Teacher / ClaIDEnd),
     data = dat) ))

assign_var%>%
  select(-var1, -var2) %>%
  mutate(
    ICC = round(vcov/sum(vcov), 2)
  )
```
```{r}
### Total Assignmnets Started

dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::mutate(n = length(StuID)) %>%
  filter(n > 20) %>%
  ggplot(aes(y = total_assignmnet_started, x = as.factor(Teacher)) ) +
  geom_jitter(alpha = .3, aes( color = condition_assignment)) +
      geom_boxplot(  outlier.shape = NA, alpha = .3) +
        theme_bw() +
  labs(
    color = "Condition"
  ) + theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  scale_x_discrete(name ="Teachers")+
  scale_y_continuous(name = "Assignments Started", breaks=c(seq(0:9))) 
```

### Problems Attempted
```{r}


problem_var<-as.data.frame( VarCorr(lmer(problems_attempted_Z_condition ~ (1 | SchIDEnd/Teacher / ClaIDEnd),
     data = dat) ))

problem_var %>%
  select(-var1, -var2) %>%
  mutate(
    ICC = round(vcov/sum(vcov), 2)
  )
```
```{r}
dat$School <- ifelse(is.na(dat$SchIDEnd), dat$SchIDPre, dat$SchIDEnd)

# total Problems Completed
 
dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::mutate(n = length(StuID)) %>%
  filter(n > 20) %>%
  ggplot(aes(y = problems_attempted_Z_condition, x = as.factor(Teacher)) ) +
  geom_jitter(alpha = .3, aes( color = condition_assignment)) +
      geom_boxplot(  outlier.shape = NA, alpha = .3) +
  theme_classic() +
  labs(
    color = "Condition"
  ) + theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  scale_x_discrete(name ="Teachers")+
  scale_y_continuous(name = "Total Problems (Z-Score)") +
  facet_grid(. ~ School, scale="free", space="free_x") +
  ggtitle("Schools") +
  theme(plot.title = element_text(hjust = 0.5, size = 10))


```
### Porblems Per assignment
```{r}

prob_per_session_var<-as.data.frame( VarCorr(lmer(avg_problems_completed_per_assign_Z_condition ~ (1 | SchIDEnd/Teacher / ClaIDEnd),
     data = dat) ))

prob_per_session_var%>%
  select(-var1, -var2) %>%
  mutate(
    ICC = vcov/sum(vcov)
  )

```
```{r}
# avg_problems_completed_per_assign
dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::mutate(n = length(StuID)) %>%
  filter(n > 20) %>%
  ggplot(aes(y = avg_problems_completed_per_assign_Z_condition, x = as.factor(Teacher)) ) +
  geom_jitter(alpha = .3, aes( color = condition_assignment)) +
      geom_boxplot(  outlier.shape = NA, alpha = .3) +
        theme_classic() +
  labs(
    color = "Condition"
  ) + theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  scale_x_discrete(name ="Teachers")+
  scale_y_continuous(name = "Problems per Assignment (Z-Score)") +
  facet_grid(. ~ School, scale="free", space="free_x") +
  ggtitle("Schools") +
  theme(plot.title = element_text(hjust = 0.5, size = 10))


```

# RQ3
## aggrigated dtata
```{r}

dat_teacher<-dat %>%
  filter(
    condition_assignment != "DragonBox",
    is.na(TeaIDEnd) == F
         ) %>%
  dplyr::select(TeaIDEnd,
         StuID,
         total_assignmnet_started ,
         problems_attempted_Z_condition ,
         avg_problems_completed_per_assign_Z_condition ) %>%
  mutate(total_assignmnet_started = ifnull(total_assignmnet_started, 0),
         problems_attempted_Z_condition = ifnull(problems_attempted_Z_condition, 0),
         avg_problems_completed_per_assign_Z_condition = ifnull(avg_problems_completed_per_assign_Z_condition, 0)) %>%
  dplyr::group_by(
    TeaIDEnd 
  ) %>%
  dplyr::summarise(
    n = length(StuID),
    assignmnet_started_mean = mean(((total_assignmnet_started/9)*100), na.rm = T),
    assignmnet_started_sd =  sd(((total_assignmnet_started/9)*100), na.rm = T),
     problems_attempted_Z_condition_mean = mean((problems_attempted_Z_condition), na.rm = T),
     problems_attempted_Z_condition_sd = sd((problems_attempted_Z_condition), na.rm = T),
    problems_completed_per_assign_Z_condition_mean = mean((avg_problems_completed_per_assign_Z_condition), na.rm = T),
    problems_completed_per_assign_Z_condition_sd = sd((avg_problems_completed_per_assign_Z_condition), na.rm = T)
  ) %>%
  na.omit()


```

## number of clsuteres
```{r}
# find best model fit
lpa_teacherBIC <- mclustBIC(
  dat_teacher %>% 
    dplyr::select(-TeaIDEnd, -n) %>%  
    na.omit(),
  prior = priorControl(functionName = "defaultPrior")
)
BIC<- melt(lpa_teacherBIC[1:9,]) %>%
  rename(
    'Number of Clusters' =Var1,
    'Model' = Var2,
    'BIC' = value
    
  )

ggplot(BIC, aes(x = `Number of Clusters`, y = BIC, color = Model)) +
  geom_path(alpha = .8) +
  geom_point(alpha = .8) +
  scale_x_continuous(breaks = 1:9) +
  theme_bw() +
  labs( y = "BIC")


```

## Run LPA
```{r}
# run cluster analysis 
lpa_teacher <- Mclust(dat_teacher %>% 
                        dplyr::select(-TeaIDEnd, -n),
                        modelNames = 'VEV',
                      G = 2)

dat_teacher <- cbind(
  dat_teacher,
  lpa_teacher$classification,
  lpa_teacher$uncertainty) %>%
  dplyr::rename(
    class = `lpa_teacher$classification`,
    uncertainty = `lpa_teacher$uncertainty`
  )

cprob <- cbind(lpa_teacher$z, lpa_teacher$classification) 
cprob <- as.data.frame(cprob) 
colnames(cprob) <- c("prob (class 1)", "prob (class 2)", "class") 
round(aggregate(cprob[, 1:2], list(cprob$class), mean), 7)



# In the results reported above, the NA values mean that a particular model cannot be estimated. This happens in practice due to singularity in the covariance matrix estimate and can be avoided using the Bayesian regularisation proposed in Fraley and Raftery (2007a) and implemented in mclust as described in Fraley et al. (2012).
# Fraley C, Raftery AE. Bayesian regularization for normal mixture estimation and model-based clustering. Journal of Classification. 2007a;24(2):155–181. [Google Scholar]
# Fraley C, Raftery AE. Model-based methods of classification: using the mclust software in chemometrics. Journal of Statistical Software. 2007b;18(6):1–13. [Google Scholar]

```

```{r}
# plot_ly(
#   x = dat_teacher$assignmnet_completed_mean,
#   z = dat_teacher$problems_attempted_Z_condition_mean,
#   y = dat_teacher$problems_completed_per_assign_Z_condition_mean,
#   type = "scatter3d",
#   mode = "markers",
#   color = as.factor(dat_teacher$class)
# )
```

## denisity scatter plots
```{r}

ggplot(dat_teacher, aes(x= assignmnet_started_mean, y = problems_attempted_Z_condition_mean, color = as.factor(class),  size = n)) +
  geom_density2d() +
  geom_point(alpha = .8) +
  theme_classic()

ggplot(dat_teacher, aes(x= assignmnet_started_mean, y = problems_completed_per_assign_Z_condition_mean, color = as.factor(class), size = n)) +
  geom_density2d() +
  geom_point(alpha = .8) +
  theme_classic()
```


```{r}
# install.packages("stringr")          
# Install stringr package
# library("stringr") 

dat_teacher_long <-dat_teacher %>%
  mutate(
      'Assignments Complete Mean' = scale(assignmnet_started_mean),
      'Assignments Complete SD' = scale(assignmnet_started_sd),
      'Total Problems Mean' = scale(problems_attempted_Z_condition_mean),
      'Total Problems SD' = scale(problems_attempted_Z_condition_sd),
      'Problems per Assignment Mean' = scale(problems_completed_per_assign_Z_condition_mean),
      'Problems per Assignment SD' = scale(problems_completed_per_assign_Z_condition_sd)) %>%
  melt(
    id.vars = c('TeaIDEnd', 'class', 'n'),
    measure.vars = c(
      'Assignments Complete Mean',
      'Assignments Complete SD',
      'Total Problems Mean',
      'Total Problems SD',
      'Problems per Assignment Mean',
      'Problems per Assignment SD' )
    
  ) %>%
  mutate(
    var = ifelse( grepl('Mean', variable), "Mean",
                  "Standard Deviation"),
    variable2 = factor(str_remove(str_remove(variable, ' (Mean)'), ' SD'), levels = c("Assignments Complete",
                                                                                      "Total Problems",
                                                                                      "Problems per Assignment"
                                                                                       ))
                  
  )
levels(as.factor(dat_teacher_long$variable2))
#dat_teacher_long$variable2 = factor(temp$size, levels=c('50%','100%','150%','200%'))


ggplot(dat_teacher_long, aes(x = var, y = value)) +
  geom_jitter(aes(group = as.factor(class), color = as.factor(class), size = n), alpha = .3) +
  geom_boxplot(aes(fill = as.factor(class)), alpha = .8) +
  theme_classic() +
  theme(
    axis.title.x = element_blank()
  )+
  ylab("z-score") +
  scale_fill_discrete(name = "Fidelity", labels = c("High", "Low")) +
  scale_color_discrete(guide = 'none') +
  scale_size(name = "Sudents") +
  scale_x_discrete(
    labels = function(x)
      str_wrap(x, width = 10)
  ) + 
  facet_grid(. ~ variable2) 
```

## ANOVA table 
```{r}


dat_teacher_long %>%
  dplyr::group_by(class, variable2, var) %>%
  dplyr::summarise(
    mean = mean(value),
    SD = sd(value)) %>% 
  arrange(variable2, var)


dat_teacher_long %>%
  group_by(variable) %>%
  dplyr::summarise(
    f = round((summary(aov(value ~ class)))[[1]][1,4], 2),
    p = round((summary(aov(value ~ class)))[[1]][1,5], 3)
    )
  

```






# EXPLORITORY:
### Teacher Level Fidelity Metrics
```{r}
length(unique(dat$TeaIDEnd))
table(is.na(dat$TeaIDEnd), is.na(dat$TeaIDPre))

dat$Teacher <- ifelse(is.na(dat$TeaIDEnd) == T, dat$TeaIDPre, dat$TeaIDEnd)

### Total Assignmnets Started

dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::mutate(n = length(StuID)) %>%
  filter(n > 20) %>%
  ggplot(aes(y = total_assignmnet_started, x = as.factor(Teacher)) ) +
  geom_jitter(alpha = .3, aes( color = condition_assignment)) +
      geom_boxplot(  outlier.shape = NA, alpha = .3) +
        theme_classic() +
  labs(
    color = "Condition"
  ) + theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  scale_x_discrete(name ="Teachers")+
  scale_y_continuous(name = "Assignments Started", breaks=c(seq(0:9))) 

lmer(total_assignmnet_started ~ (1|Teacher),
       data = dat) 
 2.569 /(2.569 +2.539)

 # total Problems Completed
 
dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::mutate(n = length(StuID)) %>%
  filter(n > 20) %>%
  ggplot(aes(y = problems_attempted_Z_condition, x = as.factor(Teacher)) ) +
  geom_jitter(alpha = .3, aes( color = condition_assignment)) +
      geom_boxplot(  outlier.shape = NA, alpha = .3) +
        theme_classic() +
  labs(
    color = "Condition"
  ) + theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  scale_x_discrete(name ="Teachers")+
  scale_y_continuous(name = "Problems Attempted (Z-Score)", breaks=c(seq(0:9)))

lmer(problems_attempted_Z_condition ~ (1|Teacher),
       data = dat) 
0.5965/(0.5965+0.8395)


# avg_problems_completed_per_assign


 
dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::mutate(n = length(StuID)) %>%
  filter(n > 20) %>%
  ggplot(aes(y = avg_problems_completed_per_assign, x = as.factor(Teacher)) ) +
  geom_jitter(alpha = .3, aes( color = condition_assignment)) +
      geom_boxplot(  outlier.shape = NA, alpha = .3) +
        theme_classic() +
  labs(
    color = "Condition"
  ) + theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  scale_x_discrete(name ="Teachers")+
  scale_y_continuous(name = "Problems Attempted (Z-Score)", breaks=c(seq(0:9)))

lmer(avg_problems_completed_per_assign ~ (1|Teacher),
       data = dat) 
0.5965/(0.5965+0.8395)



dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::mutate(n = length(StuID)) %>%
  filter(n > 20) %>%
  ggplot(aes(y = avg_problems_completed_per_assign, x = as.factor(Teacher)) ) +
  geom_jitter(alpha = .3, aes( color = condition_assignment)) +
      geom_boxplot(  outlier.shape = NA, alpha = .3) +
        theme_classic() +
  labs(
    color = "Condition"
  ) + theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  scale_x_discrete(name ="Teachers")+
  scale_y_continuous(name = "Problems Attempted (Z-Score)", breaks=c(seq(0:9)))


```

# Principal Components Anaylsis
### try muti-demintion scaling
```{r}

dat_fid_pca   <-   dat %>% 
          filter(condition_assignment != "DragonBox") %>%
          select(percent_assignmnet_complete,
                       percent_assignmnet_started,
                       in_program_time_mins,
                       problems_attempted_Z_condition,
                       avg_problems_completed_per_assign, 
                       per_problems_attempted
                       ) %>%
  mutate(in_program_time_mins =ifnull(in_program_time_mins)) %>%
  na.omit()

mice::md.pattern(dat_fid_pca)
  
pca<-prcomp(dat_fid_pca, center = TRUE,scale. = TRUE)
summary(pca)

library(devtools)
install_github("vqv/ggbiplot", force = T)
library(ggbiplot)
install.packages("remotes")
remotes::install_github("vqv/ggbiplot")
ggbiplot(pca, aplha = .2, labels = NULL)
ggbiplot(pca, aplha = .2, group = dat$StuID)

pca$rotation



k<- dat %>%
          filter(condition_assignment != "DragonBox") %>%
          select(percent_assignmnet_complete,
                       percent_assignmnet_started,
                       in_program_time_mins,
                       problems_attempted_Z_condition,
                       avg_problems_completed_per_assign, 
                       per_problems_attempted
                       ) %>%
  mutate(in_program_time_mins =ifnull(in_program_time_mins)) %>%
  na.omit() %>%
  kmeans()


```

### Teacher Level Fidelity Metrics




### Class Level Fidelity Metrics
```{r}
length(unique(dat$ClaIDEnd)) 
table(is.na(dat$ClaIDEnd), is.na(dat$ClaIDPre))

dat$Class <- ifelse(is.na(dat$ClaIDEnd) == T, dat$ClaIDPre, dat$ClaIDEnd)
table(is.na(dat$Class))

length(unique(paste(dat$Class, dat$Teacher)))


classes<-dat %>%
  dplyr::group_by(Class) %>%
  dplyr::summarise(
    nteachers = n_distinct(Teacher)
  )
table(classes$nteachers)
Teachers<-dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::summarise(
    nclasses = n_distinct(Class)
  )
table(Teachers$nclasses)

dat %>%
  dplyr::group_by(ClaIDEnd) %>%
  dplyr::mutate(n = length(StuID)) %>%
  arrange(Teacher) %>%
  filter(n > 20) %>%
  ggplot(aes(y = total_assignmnet_started, x = as.factor(Teacher), group = as.factor(Class))) +
  geom_jitter(alpha = .3, aes(color = condition_assignment)) +
  geom_boxplot(outlier.shape = NA, alpha = .3,position =  position_dodge2(width = 2000000, preserve = "single")) +
  theme_classic() +
  labs(color = "Condition") +
  # theme(axis.text.x = element_blank(),
  #       axis.ticks = element_blank()) +
  scale_x_discrete(name = "Teachers (Individual Box Plot for each Class)") +
  scale_y_continuous(name = "Assignments Started", breaks = c(seq(0:9))) +
  guides(fill = "none")


1.033/(1.033+2.488+2.309)
#[1] 0.177187
2.488/(1.033+2.488+2.309)
#[1] 0.4267581

 
 
dat %>%
  dplyr::group_by(Teacher) %>%
  dplyr::mutate(n = length(StuID)) %>%
  filter(n > 20) %>%
  ggplot(aes(y = problems_attempted_Z_condition, x = as.factor(ClaIDEnd), color = as.factor(Teacher)) ) +
  #geom_jitter(alpha = .3, aes( color = condition_assignment)) +
      geom_boxplot(  outlier.shape = NA, alpha = .3) +
        theme_classic() +
  labs(
    color = "Condition"
  ) + theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  scale_x_discrete(name ="Teachers")+
  scale_y_continuous(name = "Problems Attempted (Z-Score)", breaks=c(seq(0:9))) +
  guides(color = element_blank())

lmer(problems_attempted_Z_condition ~ (1|Teacher),
       data = dat) 
0.5965/(0.5965+0.8395)

group_by(teach)

```




```{r}
# create data file with one row per class for fidelity metrics
class <- dat %>%
  ungroup() %>%
  group_by(ClaIDEnd) %>%
  dplyr::summarise(num_students = n(),
            num_started_assignment_2= sum(ifnull(started_assignment_2),0),
            num_started_assignment_3= sum(ifnull(started_assignment_3),0),
            num_started_assignment_4= sum(ifnull(started_assignment_4),0),
            num_started_assignment_5= sum(ifnull(started_assignment_5),0),
            num_started_assignment_7= sum(ifnull(started_assignment_7),0),
            num_started_assignment_8= sum(ifnull(started_assignment_8),0),
            num_started_assignment_9= sum(ifnull(started_assignment_9),0),
            num_started_assignment_10= sum(ifnull(started_assignment_10),0),
            num_started_assignment_11= sum(ifnull(started_assignment_11),0),
            pre_started_assignment_2= mean(started_assignment_2),
            pre_started_assignment_3= mean(started_assignment_3),
            pre_started_assignment_4= mean(started_assignment_4),
            pre_started_assignment_5= mean(started_assignment_5),
            pre_started_assignment_7= mean(started_assignment_7),
            pre_started_assignment_8= mean(started_assignment_8),
            pre_started_assignment_9= mean(started_assignment_9),
            pre_started_assignment_10= mean(started_assignment_10),
            pre_started_assignment_11= mean(started_assignment_11),
            num_complete_assignment_2= sum(ifnull(complete_assignment_2),0),
            num_complete_assignment_3= sum(ifnull(complete_assignment_3),0),
            num_complete_assignment_4= sum(ifnull(complete_assignment_4),0),
            num_complete_assignment_5= sum(ifnull(complete_assignment_5),0),
            num_complete_assignment_7= sum(ifnull(complete_assignment_7),0),
            num_complete_assignment_8= sum(ifnull(complete_assignment_8),0),
            num_complete_assignment_9= sum(ifnull(complete_assignment_9),0),
            num_complete_assignment_10= sum(ifnull(complete_assignment_10),0),
            num_complete_assignment_11= sum(ifnull(complete_assignment_11),0),
            pre_complete_assignment_2= mean(complete_assignment_2),
            pre_complete_assignment_3= mean(complete_assignment_3),
            pre_complete_assignment_4= mean(complete_assignment_4),
            pre_complete_assignment_5= mean(complete_assignment_5),
            pre_complete_assignment_7= mean(complete_assignment_7),
            pre_complete_assignment_8= mean(complete_assignment_8),
            pre_complete_assignment_9= mean(complete_assignment_9),
            pre_complete_assignment_10= mean(complete_assignment_10),
            pre_complete_assignment_11= mean(complete_assignment_11)
            
            ) %>%
  mutate(
    percent_assignments_started = 
      (num_started_assignment_2 +
      num_started_assignment_3 +
      num_started_assignment_4 +
      num_started_assignment_5 +
      num_started_assignment_7 +
      num_started_assignment_8 +
      num_started_assignment_9 +
      num_started_assignment_10 +
      num_started_assignment_11 )/(num_students*9),
       percent_assignments_complete = 
      (num_complete_assignment_2 +
      num_complete_assignment_3 +
      num_complete_assignment_4 +
      num_complete_assignment_5 +
      num_complete_assignment_7 +
      num_complete_assignment_8 +
      num_complete_assignment_9 +
      num_complete_assignment_10 +
      num_complete_assignment_11 )/(num_students*9)
    
  )


# overall 
mean(class$percent_assignments_complete)
sd(class$percent_assignments_complete)
table(class$percent_assignments_complete == 1)/length(class$percent_assignments_complete)


```





## Calculating Fedility Metric
```{r}
length(unique(class$final_teacher_class))
table(class$num_students)
# why are there classes with 56 students?
# there are also 69 students without a final class id

# overall percent students started lesson in class
describe(class$percent_assignments_started)

ggplot(
  data = class,
  aes(x = percent_assignments_started)) +
  geom_density(adjust = 1.5, alpha = .6,  fill = "#00BFC4") +
  theme_minimal() +
  labs(       x = "Precent of Assignments Started In Each Class") +
  theme(plot.title = element_text(hjust = 0.5)
        ) +
  geom_vline(xintercept=.25,linetype="dotted",   size=.75) +
  theme_classic()

# number who met this metric
table(class$pre_assignments_started > .25)


# fidelity for each assignment
class <- class %>%
  mutate(a2_fedility = ifelse(pre_started_assignment_2 >.25, 1),
         a3_fedility = ifelse(pre_started_assignment_3 >.25, 1),
         a4_fedility = ifelse(pre_started_assignment_4 >.25, 1),
         a5_fedility = ifelse(pre_started_assignment_5 >.25, 1),
         a7_fedility = ifelse(pre_started_assignment_7 >.25, 1),
         a8_fedility = ifelse(pre_started_assignment_8 >.25, 1),
         a9_fedility = ifelse(pre_started_assignment_9 >.25, 1),
         a10_fedility = ifelse(pre_started_assignment_10 >.25, 1),
         a11_fedility = ifelse(pre_started_assignment_11 >.25, 1),
         )
table(class$a2_fedility)
table(class$a3_fedility)
table(class$a4_fedility)
table(class$a5_fedility)
table(class$a7_fedility)
table(class$a8_fedility)
table(class$a9_fedility)
table(class$a10_fedility)
table(class$a11_fedility)
      
class$overall_fideility<-ifelse(
      (class$a2_fedility) ==1&
      (class$a3_fedility) ==1&
      (class$a4_fedility) ==1&
      (class$a5_fedility) ==1&
      (class$a7_fedility) ==1& 
      (class$a8_fedility) ==1& 
      (class$a9_fedility) ==1& 
      (class$a10_fedility) ==1&
      (class$a11_fedility) ==1, 1)
table(class$overall_fideility)

table(is.na(class$overall_fideility))
table(is.na(class$overall_fideility))

mean(class$a2_fedility, na.rm = T)
mean(class$a3_fedility, na.rm = T)
mean(class$a4_fedility, na.rm = T)
mean(class$a5_fedility, na.rm = T)
mean(class$a7_fedility, na.rm = T)
mean(class$a8_fedility, na.rm = T)
mean(class$a9_fedility, na.rm = T)
mean(class$a10_fedility, na.rm = T)
mean(class$a11_fedility, na.rm = T)

dat <- dat %>%
  left_join(
    class %>%
      select(
        final_teacher_class, 
        final_school_id,
        overall_fideility,
        pre_assignments_started
      ),
    by = c("final_school_id", "final_teacher_class")
  )

# there is almost of missing data here
table(is.na(dat$overall_fideility))
table(is.na(dat$post.percentage_math_score),is.na(dat$overall_fideility))
table(is.na(dat$pre.percentage_math_score),is.na(dat$overall_fideility))
```

## Pretest Scores by Fidelity 
```{r}
ggplot(
  dat[is.na(dat$) == F &
           is.na(dat$overall_fideility) == F, ],
  aes(x =  as.factor(overall_fideility), 
      y = pre.percentage_math_score,
      group = overall_fideility,
      
      )
) +
  labs(title ="Pre Test Scores by Fideility",
    #   subtitle = "",
       y = "Pretest Score",
       x = "Class Level Fidelity ") +
  geom_boxplot(alpha = .7) +
  theme_minimal()

ggplot(
  dat[is.na(dat$post.percentage_math_score) == F &
           is.na(dat$overall_fideility) == F, ],
  aes(x = as.factor(overall_fideility), 
      y = pre.percentage_math_score,
  #    grpup = as.factor(virtual),
      fill = as.factor(virtual)
      
      )
) +
  labs(title ="Pre Test Scores by Fideility",
    #   subtitle = "",
       y = "Pretest Score",
       x = "Class Level Fidelity ") +
  geom_boxplot(alpha = .7) +
  theme_minimal()


```
# Models
``` {r models}
Null_Model <- 


```